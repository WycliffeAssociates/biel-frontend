---
import "../styles/wordpress.scss";
import "../styles/global.scss";
import "../styles/vars.scss";
import {pwaInfo} from "virtual:pwa-info";
import Blocks from "@components/Blocks.astro";
import type {languageType} from "@customTypes/types";
import {getEnglishUriMap, getFooter} from "@src/data/wp";

interface Props {
  title: string;
  langInfo: languageType;
  langSwitcher: languageType[];
  inlineCss: string[];
  description: string;
  langDirection: "ltr" | "rtl";
}
import {ViewTransitions} from "astro:transitions";
import {cacheFooterForDev, getCachedFooter} from "@lib/caching";
import {adjustCmsDomLinks} from "@src/utils";
const gqlUrl =
  import.meta.env.WORDPRESS_GQL_URL ||
  Astro.locals.runtime.env?.WORDPRESS_GQL_URL;

const {title, inlineCss, langInfo, langSwitcher, description, langDirection} =
  Astro.props;
const forceRefresh = true;
const cachedFooter =
  import.meta.env.DEV && getCachedFooter(forceRefresh)
    ? getCachedFooter()
    : null;
const footerData = cachedFooter
  ? cachedFooter
  : await getFooter({langCode: langInfo.code, gqlUrl});
import.meta.env.DEV && cacheFooterForDev(footerData);
const {footerInlineStyles, footer} = footerData
  ? footerData
  : {footerInlineStyles: "", footer: {content: ""}};
const allStyles = [...inlineCss, ...footerInlineStyles];
const deduped = new Set(allStyles);
const dedupedInlineStyles = [...deduped].join("\n");
const {englishUriMap} = await getEnglishUriMap({gqlUrl});
---

<html lang={langInfo.code} dir={langDirection}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="/favicon.ico" sizes="32x32" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" /><!-- 180Ã—180 -->
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    {inlineCss && <style id="headlessStyles" set:html={dedupedInlineStyles} />}
    <script src="/src/pwa.ts"></script>
    {pwaInfo && <Fragment set:html={pwaInfo.webManifest.linkTag} />}
    {
      langSwitcher.map((version) => {
        return (
          <link
            rel="alternate"
            href={
              version.localizedUrl ||
              `${version.code == "en" ? "/" : `/${version.code}`}`
            }
            hreflang={version.code}
          />
        );
      })
    }
    <ViewTransitions />
  </head>
  <body>
    <div class="site bg-surface-primary">
      <slot />
      <footer class="wp-blocks site-footer">
        <Blocks
          content={adjustCmsDomLinks({
            stringToParse: footer.content,
            currentLangCode: langInfo.code,
            englishUriMap,
          })}
        />
      </footer>
    </div>
  </body>
</html>
